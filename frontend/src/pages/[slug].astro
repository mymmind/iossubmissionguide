---
import Layout from '../layouts/Layout.astro';
import DOMPurify from 'isomorphic-dompurify';

interface Article {
  slug: string;
  title: string;
  description: string;
  content: string;
  isHub: boolean;
  toc?: unknown;
  publishedAt?: string;
  updatedAt?: string;
  relatedFrom?: Array<{
    targetArticle: {
      slug: string;
      title: string;
      description: string;
    };
  }>;
}

export async function getStaticPaths() {
  const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3005';
  try {
    // Fetch all articles with full content in a single query to avoid N+1
    const res = await fetch(`${apiUrl}/api/articles?full=true`);
    if (res.ok) {
      const articles: Article[] = await res.json();
      return articles
        .filter((a) => !a.isHub)
        .map((a) => ({
          params: { slug: a.slug },
          props: { article: a },
        }));
    }
  } catch (e) {
    console.error('Failed to get static paths:', e);
  }
  return [];
}

const { article } = Astro.props as { article: Article };

if (!article) {
  return Astro.redirect('/404');
}

// Sanitize HTML content to prevent XSS
// Note: onclick is intentionally NOT allowed to prevent XSS attacks
const sanitizedContent = DOMPurify.sanitize(article.content, {
  ADD_TAGS: ['section'],
  ADD_ATTR: ['target', 'rel'],
});

// Breadcrumb schema for SEO
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://iossubmissionguide.com"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": article.title,
      "item": `https://iossubmissionguide.com/${article.slug}`
    }
  ]
};

// FAQ Schema for pages (helps get rich snippets in search)
const faqData: Record<string, Array<{question: string; answer: string}>> = {
  "guideline-2-1-app-crashes": [
    {
      question: "What is Guideline 2.1 rejection?",
      answer: "Guideline 2.1 rejection occurs when Apple's review team finds that your app crashes, has bugs, or doesn't perform as expected during testing. This includes crashes on launch, freezes, broken features, or performance issues."
    },
    {
      question: "How do I fix a Guideline 2.1 rejection?",
      answer: "To fix a 2.1 rejection: 1) Reproduce the crash using the exact device and iOS version mentioned by Apple, 2) Check crash logs in Xcode Organizer, 3) Test thoroughly on real devices, 4) Ensure all features work offline/online, 5) Fix memory leaks and optimize performance, then resubmit."
    },
    {
      question: "How long does it take to get approved after fixing crashes?",
      answer: "After fixing crashes and resubmitting, Apple typically reviews your app within 24-48 hours. Expedited reviews are available for critical bug fixes. Include detailed notes explaining what you fixed."
    }
  ],
  "guideline-3-1-in-app-purchase": [
    {
      question: "What is Guideline 3.1 rejection?",
      answer: "Guideline 3.1 rejection happens when your app offers digital goods or services that must be purchased through Apple's In-App Purchase system but uses external payment methods instead, or when IAP implementation is incorrect."
    },
    {
      question: "What purchases require Apple's In-App Purchase?",
      answer: "Digital content (ebooks, music, videos), subscriptions to digital services, premium features, virtual currency, and unlocking app functionality all require In-App Purchase. Physical goods, real-world services, and person-to-person services are exempt."
    },
    {
      question: "How do I fix a Guideline 3.1 rejection?",
      answer: "To fix 3.1: 1) Remove external payment links for digital goods, 2) Implement StoreKit for all digital purchases, 3) Use the correct IAP product types, 4) Restore purchases functionality must work, 5) Don't mention external payment options in the app."
    }
  ],
  "guideline-4-2-minimum-functionality": [
    {
      question: "What is Guideline 4.2 rejection?",
      answer: "Guideline 4.2 rejection occurs when Apple determines your app doesn't provide enough features, functionality, or content to be considered a standalone app. This often affects simple wrapper apps, basic utilities, or apps that could be websites."
    },
    {
      question: "How do I fix a Guideline 4.2 minimum functionality rejection?",
      answer: "To fix 4.2: 1) Add native iOS features (widgets, notifications, Siri shortcuts), 2) Implement offline functionality, 3) Add unique value beyond a website, 4) Include personalization features, 5) Use device capabilities (camera, sensors, haptics)."
    },
    {
      question: "Can a simple app get approved on the App Store?",
      answer: "Yes, simple apps can be approved if they provide genuine utility and use native iOS capabilities. Focus on doing one thing excellently rather than adding unnecessary features. Apps should offer value that justifies installation over using a website."
    }
  ],
  "rejection-guide": [
    {
      question: "What are the most common App Store rejection reasons?",
      answer: "The most common rejection reasons are: 1) Crashes and bugs (30%), 2) Broken links or placeholder content, 3) Missing privacy policy, 4) Guideline 4.2 minimum functionality, 5) Guideline 2.1 performance issues, 6) Missing demo account credentials, 7) Inaccurate metadata or screenshots."
    },
    {
      question: "What percentage of apps get rejected on first submission?",
      answer: "According to Apple, roughly 40-50% of first-time submissions get rejected. However, 90% of submissions are reviewed within 24 hours, and most rejections can be resolved and resubmitted quickly."
    },
    {
      question: "How can I avoid App Store rejection?",
      answer: "To avoid rejection: 1) Test thoroughly on real devices, 2) Include a working privacy policy URL, 3) Provide demo login credentials if needed, 4) Ensure all features work completely, 5) Follow Apple's Human Interface Guidelines, 6) Review the App Store Review Guidelines before submission."
    }
  ],
  "rejection-recovery": [
    {
      question: "What should I do after my app is rejected?",
      answer: "After rejection: 1) Read the rejection message carefully to understand the specific issue, 2) Check Resolution Center in App Store Connect for details, 3) Fix the identified issues, 4) Add detailed reviewer notes explaining your changes, 5) Resubmit through App Store Connect."
    },
    {
      question: "Can I appeal an App Store rejection?",
      answer: "Yes, you can appeal through the App Review Board if you believe the rejection was incorrect. Use the Appeal button in Resolution Center. Provide clear evidence and reasoning. Appeals are reviewed by a different team and typically take 1-2 business days."
    },
    {
      question: "How do I communicate with App Review?",
      answer: "Use the Resolution Center in App Store Connect to reply to rejections. Be professional and specific. You can ask clarifying questions, provide additional context, or explain why you believe the rejection was incorrect. Response times are usually within 24-48 hours."
    }
  ],
  "app-store-review-time-2025": [
    {
      question: "How long does App Store review take in 2025?",
      answer: "According to Apple, 90% of app submissions are reviewed within 24 hours. Most apps are reviewed within 24-48 hours. Complex apps or those requiring additional review may take longer. First-time submissions sometimes take slightly longer than updates."
    },
    {
      question: "Can I request an expedited App Store review?",
      answer: "Yes, you can request an expedited review through App Store Connect for critical bug fixes, security issues, or time-sensitive events. Apple reviews these requests case-by-case. Include a clear explanation of why the expedite is needed."
    },
    {
      question: "Why is my App Store review taking so long?",
      answer: "Extended review times can occur due to: 1) Complex app features requiring additional scrutiny, 2) Potential guideline violations needing manual review, 3) Holiday periods with higher submission volumes, 4) Apps in sensitive categories (health, finance, kids). Contact Apple through Resolution Center if review exceeds 5 business days."
    }
  ],
  "app-store-privacy-policy-requirements": [
    {
      question: "Do I need a privacy policy for my iOS app?",
      answer: "Yes, all apps on the App Store require a privacy policy. This is mandatory under Guideline 5.1.1 regardless of whether your app collects user data. The privacy policy must be accessible via a public URL and linked in App Store Connect."
    },
    {
      question: "What must be included in an App Store privacy policy?",
      answer: "Your privacy policy must include: 1) What data you collect, 2) How data is used, 3) Third-party services that receive data, 4) Data retention periods, 5) User rights regarding their data, 6) Contact information. It must match your App Privacy nutrition labels in App Store Connect."
    },
    {
      question: "Where do I add my privacy policy URL in App Store Connect?",
      answer: "Add your privacy policy URL in App Store Connect under App Information > Privacy Policy URL. The URL must be publicly accessible without login. You can also add it to your app's Settings screen for in-app access."
    }
  ],
  "react-native-app-store-submission": [
    {
      question: "How do I submit a React Native app to the App Store?",
      answer: "To submit a React Native app: 1) Build with EAS Build or locally using Xcode, 2) Configure app.json/app.config.js with correct bundle ID and version, 3) Generate iOS build with proper signing, 4) Upload via Xcode or Transporter, 5) Complete App Store Connect metadata, 6) Submit for review."
    },
    {
      question: "Do React Native apps get rejected more often?",
      answer: "React Native apps are not rejected more often if built correctly. Common issues specific to React Native include: JavaScript bundle not loading, missing native permissions in Info.plist, and Hermes-related crashes. Test thoroughly on real devices before submission."
    },
    {
      question: "Should I use Expo or bare React Native for App Store submission?",
      answer: "Both work well for App Store submission. Expo with EAS Build simplifies the process with managed signing and building. Bare React Native gives more control but requires manual Xcode configuration. Choose based on your app's native module requirements."
    }
  ],
  "connect-guide": [
    {
      question: "How do I create an app in App Store Connect?",
      answer: "To create an app: 1) Log into App Store Connect, 2) Click My Apps > + > New App, 3) Select iOS platform, 4) Enter app name and primary language, 5) Choose a Bundle ID (must match Xcode), 6) Create a unique SKU, 7) Select user access level."
    },
    {
      question: "What is TestFlight and how do I use it?",
      answer: "TestFlight is Apple's beta testing platform. Upload a build to App Store Connect, then: 1) Add internal testers (up to 100, instant access), 2) Create external testing groups (up to 10,000 testers, requires Beta App Review), 3) Share invite links or add testers by email. Builds expire after 90 days."
    },
    {
      question: "How do I upload an app build to App Store Connect?",
      answer: "You can upload builds via: 1) Xcode: Product > Archive > Distribute App > App Store Connect, 2) Transporter app: Upload .ipa files directly, 3) altool command line: xcrun altool --upload-app. All methods require valid App Store Connect credentials and signing certificates."
    }
  ]
};

const faqSchema = faqData[article.slug] ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faqData[article.slug].map(faq => ({
    "@type": "Question",
    "name": faq.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": faq.answer
    }
  }))
} : null;

// Article schema for SEO
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": article.title,
  "description": article.description,
  "image": {
    "@type": "ImageObject",
    "url": "https://iossubmissionguide.com/og-image.webp",
    "width": 1200,
    "height": 630
  },
  "inLanguage": "en-US",
  "author": {
    "@type": "Organization",
    "name": "iOS Submission Guide",
    "url": "https://iossubmissionguide.com"
  },
  "publisher": {
    "@type": "Organization",
    "name": "iOS Submission Guide",
    "url": "https://iossubmissionguide.com",
    "logo": {
      "@type": "ImageObject",
      "url": "https://iossubmissionguide.com/favicon.svg",
      "width": 512,
      "height": 512
    }
  },
  "url": `https://iossubmissionguide.com/${article.slug}`,
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://iossubmissionguide.com/${article.slug}`
  },
  "datePublished": article.publishedAt || "2024-12-01",
  "dateModified": article.updatedAt || new Date().toISOString().split('T')[0]
};
---

<Layout title={article.title} description={article.description} toc={article.toc}>
  <!-- Breadcrumb Schema JSON-LD -->
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  <!-- Article Schema JSON-LD -->
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
  <!-- FAQ Schema JSON-LD (for guideline pages) -->
  {faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />}

  <!-- Visible Breadcrumb Navigation -->
  <nav class="mb-8" aria-label="Breadcrumb">
    <ol class="flex items-center gap-2 text-sm text-gray-500">
      <li>
        <a href="/" class="hover:text-apple-blue transition-colors">Home</a>
      </li>
      <li class="flex items-center gap-2">
        <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <span class="text-apple-dark font-medium">{article.title}</span>
      </li>
    </ol>
  </nav>

  <article>
    <div set:html={sanitizedContent} />
  </article>

  {article.relatedFrom && article.relatedFrom.length > 0 && (
    <div class="mt-20 pt-10 border-t border-gray-100">
      <h3 class="text-xl font-bold text-apple-dark mb-6">Deep Dive Guides</h3>
      <div class="feature-grid">
        {article.relatedFrom.map((rel) => (
          <a href={`/${rel.targetArticle.slug}`} class="feature-card group">
            <h4 class="text-lg font-bold text-apple-dark group-hover:text-apple-blue transition-colors">{rel.targetArticle.title}</h4>
            <p class="text-sm text-apple-gray mt-2">{rel.targetArticle.description}</p>
          </a>
        ))}
      </div>
    </div>
  )}
</Layout>
