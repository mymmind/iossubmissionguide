---
import { getUIStrings, type Language } from '../i18n/translations';
import LanguageSwitcher from './LanguageSwitcher.astro';

interface NavArticle {
  slug: string;
  title: string;
  category: string;
}

interface TocItem {
  href: string;
  label: string;
}

interface TocSection {
  section: string | null;
  items: TocItem[];
}

interface Toc {
  title: string;
  backLink?: string;
  sections: TocSection[];
}

interface Props {
  articles: NavArticle[];
  pathname: string;
  toc?: Toc;
  lang?: Language;
}

const { articles, pathname, toc, lang = 'en' } = Astro.props;
const ui = getUIStrings(lang);
const langPrefix = lang === 'en' ? '' : `/${lang}`;
const isHomePage = pathname === '/' || pathname === '' || pathname === '/zh' || pathname === '/zh/';

const mainGuideNav = [
  {
    section: null,
    items: [
      { href: `${langPrefix}/`, label: ui.nav.introduction },
      { href: `${langPrefix}/#pre-submission`, label: ui.nav.preSubmission },
    ],
  },
  {
    section: ui.nav.keyFocusAreas,
    items: [
      { href: `${langPrefix}/#safety`, label: ui.nav.safety },
      { href: `${langPrefix}/#performance`, label: ui.nav.performance },
      { href: `${langPrefix}/#business`, label: ui.nav.business },
      { href: `${langPrefix}/#design`, label: ui.nav.design },
      { href: `${langPrefix}/#legal`, label: ui.nav.legal },
    ],
  },
  {
    section: ui.nav.submission,
    items: [
      { href: `${langPrefix}/#listing`, label: ui.nav.storeListing },
      { href: `${langPrefix}/#process`, label: ui.nav.reviewProcess },
      { href: `${langPrefix}/#rejection`, label: ui.nav.commonRejections },
    ],
  },
  {
    section: ui.nav.premiumTools,
    items: [
      { href: `${langPrefix}/ai-review`, label: ui.nav.aiToolkit },
    ],
  },
  {
    section: null,
    items: [
      { href: `${langPrefix}/#deep-dives`, label: ui.nav.deepDives },
      { href: `${langPrefix}/#references`, label: ui.nav.references },
    ],
  },
];

function groupByCategory(articles: NavArticle[]): Record<string, NavArticle[]> {
  return articles.reduce((acc, article) => {
    if (!acc[article.category]) {
      acc[article.category] = [];
    }
    acc[article.category].push(article);
    return acc;
  }, {} as Record<string, NavArticle[]>);
}

const groupedArticles = groupByCategory(articles);
---

<aside class="hidden lg:block w-72 fixed h-screen overflow-y-auto pt-16 pb-12 pl-10 pr-6 border-r sidebar shadow-[1px_0_0_0_rgba(0,0,0,0.02)]" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
  <div class="mb-8 flex items-start justify-between">
    <div>
      <span class="text-[10px] font-bold uppercase tracking-[0.2em] text-apple-blue mb-2 block">{ui.site.edition}</span>
      <h2 class="text-2xl font-sans font-bold tracking-tight" style="color: var(--text-primary);">{ui.site.sidebarTitle}</h2>
    </div>
    <div class="flex items-center gap-1">
      <LanguageSwitcher lang={lang} pathname={pathname} />
      <button
        id="theme-toggle-sidebar"
        class="theme-toggle mt-1"
        aria-label="Toggle dark mode"
        type="button"
      >
        <svg class="moon-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
        </svg>
        <svg class="sun-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
      </button>
    </div>
  </div>

  {isHomePage ? (
    <nav class="space-y-1">
      {mainGuideNav.map((group) => (
        <div class="mb-6 last:mb-0">
          {group.section && (
            <div class="py-2 mb-1">
              <span class="text-[10px] font-bold uppercase tracking-[0.15em]" style="color: var(--text-tertiary);">
                {group.section}
              </span>
            </div>
          )}
          <div class="space-y-0.5">
            {group.items.map((item) => (
              <a
                href={item.href}
                class="group block py-2 px-3 text-[13px] font-medium rounded-xl transition-all sidebar-link"
              >
                <span class="inline-block transition-transform group-hover:translate-x-0.5">
                  {item.label}
                </span>
              </a>
            ))}
          </div>
        </div>
      ))}
    </nav>
  ) : (
    <>
      <a
        href={toc?.backLink || `${langPrefix}/`}
        class="flex items-center text-[13px] font-bold text-apple-blue hover:opacity-70 mb-10 transition-all uppercase tracking-wider"
      >
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7" />
        </svg>
        {toc ? ui.nav.backToGuide : ui.nav.mainGuide}
      </a>

      {toc && (
        <div class="mb-8">
           <span class="text-[10px] font-bold uppercase tracking-[0.2em] mb-1 block" style="color: var(--text-tertiary);">{ui.nav.deepDive}</span>
           <h3 class="text-xl font-sans font-bold tracking-tight" style="color: var(--text-primary);">{toc.title}</h3>
        </div>
      )}

      <nav class="space-y-1">
        <div class="mb-8">
          <a
            href={`${langPrefix}/ai-review`}
            class={`group block py-2 px-3 text-[13px] font-bold rounded-xl transition-all ${
              pathname === "/ai-review" || pathname === "/zh/ai-review"
                ? "bg-apple-blue text-white shadow-lg shadow-apple-blue/20"
                : "text-apple-blue bg-blue-50/50 hover:bg-blue-50"
            }`}
          >
            <span class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
              {ui.nav.aiToolkit}
            </span>
          </a>
        </div>

        {toc ? (
          toc.sections.map((group) => (
            <div class="mb-6 last:mb-0">
              {group.section && (
                <div class="py-2 mb-1">
                  <span class="text-[10px] font-bold uppercase tracking-[0.15em]" style="color: var(--text-tertiary);">
                    {group.section}
                  </span>
                </div>
              )}
              <div class="space-y-0.5">
                {group.items.map((item) => (
                  <a
                    href={item.href}
                    class="group block py-2 px-3 text-[13px] font-medium rounded-xl transition-all sidebar-link"
                  >
                    <span class="inline-block transition-transform group-hover:translate-x-0.5">
                      {item.label}
                    </span>
                  </a>
                ))}
              </div>
            </div>
          ))
        ) : (
          Object.entries(groupedArticles).map(([category, categoryArticles]) => (
            <div class="mb-6 last:mb-0">
              <div class="py-2 mb-1">
                <span class="text-[10px] font-bold uppercase tracking-[0.15em]" style="color: var(--text-tertiary);">
                  {category}
                </span>
              </div>
              <div class="space-y-0.5">
                {categoryArticles.map((article) => {
                  const isActive = pathname === `${langPrefix}/${article.slug}` || pathname === `/${article.slug}`;
                  return (
                    <a
                      href={`${langPrefix}/${article.slug}`}
                      class={`group block py-2 px-3 text-[13px] font-medium rounded-xl transition-all ${
                        isActive
                          ? 'bg-apple-blue text-white shadow-lg shadow-apple-blue/20'
                          : 'sidebar-link'
                      }`}
                    >
                      <span class={`inline-block transition-transform ${!isActive ? 'group-hover:translate-x-0.5' : ''}`}>
                        {article.title}
                      </span>
                    </a>
                  );
                })}
              </div>
            </div>
          ))
        )}
      </nav>
    </>
  )}
  <div class="mt-auto border-t pt-8" style="border-color: var(--border-subtle);">
    <div id="toolkit-sidebar-link" class="hidden mb-4">
      <a href={`${langPrefix}/success`} id="sidebar-success-link" class="flex items-center gap-3 p-3 text-apple-blue rounded-xl font-bold text-sm transition-all border sidebar-toolkit-link">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
        {ui.nav.yourToolkit}
      </a>
    </div>
    <a href={`${langPrefix}/restore`} class="text-xs font-semibold hover:text-apple-blue transition-colors flex items-center gap-2 uppercase tracking-widest px-3" style="color: var(--text-tertiary);">
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      {ui.nav.findPurchase}
    </a>
  </div>
</aside>

<script>
  // Show toolkit link if session exists (fetch from httpOnly cookie via API)
  async function checkPurchaseSession() {
    const container = document.getElementById('toolkit-sidebar-link');
    const link = document.getElementById('sidebar-success-link') as HTMLAnchorElement;

    if (!container || !link) return;

    try {
      const apiBase = window.location.hostname === 'localhost'
        ? 'http://localhost:3005'
        : window.location.origin;
      const response = await fetch(`${apiBase}/api/purchase-session`, {
        credentials: 'include',
      });

      const data = await response.json();
      if (data.sessionId) {
        container.classList.remove('hidden');
        link.href = `/success?session_id=${data.sessionId}`;
      }
    } catch (e) {
      // Silently fail - user just won't see the toolkit link
    }
  }

  checkPurchaseSession();
</script>
