---
import '../styles/globals.css';
import Sidebar from '../components/Sidebar.astro';

interface NavArticle {
  slug: string;
  title: string;
  category: string;
  isHub?: boolean;
}

interface TocItem {
  href: string;
  label: string;
}

interface TocSection {
  section: string | null;
  items: TocItem[];
}

interface Toc {
  title: string;
  backLink?: string;
  sections: TocSection[];
}

interface Props {
  title: string;
  description?: string;
  articles?: NavArticle[];
  toc?: Toc;
  noindex?: boolean;
  ogImage?: string;
  ogImageAlt?: string;
}

const {
  title,
  description = 'Comprehensive guide for passing the Apple App Store review process',
  articles = [],
  toc,
  noindex = false,
  ogImage = 'https://iossubmissionguide.com/og-image.webp',
  ogImageAlt = 'iOS Submission Guide - Pass App Store Review'
} = Astro.props;

// Determine image type from extension
const ogImageType = ogImage.endsWith('.png') ? 'image/png' : 'image/webp';
const { pathname } = Astro.url;
const umamiWebsiteId = import.meta.env.PUBLIC_UMAMI_WEBSITE_ID;

const apiUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3005';
let navArticles: NavArticle[] = articles;

if (navArticles.length === 0) {
  try {
    const res = await fetch(`${apiUrl}/api/articles`);
    if (res.ok) {
      const all: NavArticle[] = await res.json();
      navArticles = all.filter((a) => !a.isHub);
    }
  } catch (e) {
    console.error('Failed to fetch nav articles:', e);
  }
}
---

<!doctype html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5" />

    <!-- Favicons - Complete set for all browsers and devices -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}

    <!-- Google Search Console -->
    <meta name="google-site-verification" content="7IcG4abT8iqx_yApNhuhXbL1tQ-QfEFp4HxeUslkxko" />

    <!-- Mobile & PWA -->
    <meta name="theme-color" content="#007AFF" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="iOS Guide" />

    <!-- Language -->
    <link rel="alternate" hreflang="en" href={`https://iossubmissionguide.com${pathname}`} />
    <link rel="alternate" hreflang="x-default" href={`https://iossubmissionguide.com${pathname}`} />

    <!-- Canonical URL -->
    <link rel="canonical" href={`https://iossubmissionguide.com${pathname === '/' ? '' : pathname}`} />

    <!-- Open Graph / Social -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="iOS Submission Guide" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:secure_url" content={ogImage} />
    <meta property="og:image:type" content={ogImageType} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={ogImageAlt} />
    <meta property="og:url" content={`https://iossubmissionguide.com${pathname}`} />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@iossubmitguide" />
    <meta name="twitter:creator" content="@iossubmitguide" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:image:alt" content={ogImageAlt} />

    <!-- Organization Schema -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "iOS Submission Guide",
      "description": "Comprehensive guide for passing the Apple App Store review process",
      "url": "https://iossubmissionguide.com",
      "logo": {
        "@type": "ImageObject",
        "url": "https://iossubmissionguide.com/favicon.svg",
        "width": 512,
        "height": 512
      },
      "foundingDate": "2024",
      "sameAs": []
    })} />

    <!-- Font loading optimization -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <!-- Analytics prefetch -->
    {umamiWebsiteId && <link rel="dns-prefetch" href="https://cloud.umami.is" />}
    {umamiWebsiteId && (
      <script is:inline defer src="https://cloud.umami.is/script.js" data-website-id={umamiWebsiteId}></script>
    )}
  </head>
  <body class="bg-white text-apple-dark font-sans antialiased selection:bg-apple-blue selection:text-white">
    <!-- Skip Navigation Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Promotional Banner -->
    <a href="/ai-review" class="block bg-gradient-to-r from-apple-blue to-blue-700 text-white py-2 text-center text-xs font-bold tracking-widest hover:brightness-110 transition-all uppercase relative z-[70]">
        Special Year-End Offer: AI Review Toolkit $29.99 <span class="opacity-50 line-through ml-2">$49.99</span>
        <span class="ml-4 underline underline-offset-2">Get it now →</span>
    </a>

    <!-- Mobile Header -->
    <header class="lg:hidden fixed top-0 w-full glass-header border-b border-gray-200 z-50 h-16 flex items-center justify-between px-4 bg-white/80 backdrop-blur-md">
      <h1 class="font-semibold text-sm tracking-tight text-apple-dark">iOS Submission Guide</h1>
      <button
        id="mobile-menu-button"
        class="text-apple-blue font-medium py-3 px-4 -mr-4 min-h-[44px] min-w-[44px] touch-manipulation"
        aria-label="Open navigation menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
      >Menu</button>
    </header>

    <!-- Mobile Menu Overlay (Hidden by default) -->
    <div
      id="mobile-menu"
      class="fixed inset-0 z-[60] bg-white transform translate-x-full transition-transform duration-300 lg:hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="mobile-menu-title"
    >
      <div class="h-16 flex items-center justify-between px-4 border-b border-gray-100">
         <span id="mobile-menu-title" class="font-bold text-apple-dark">Menu</span>
         <button
           id="close-menu-button"
           class="text-apple-blue font-medium py-3 px-4 -mr-4 min-h-[44px] min-w-[44px] touch-manipulation"
           aria-label="Close navigation menu"
         >Close</button>
      </div>
      <nav class="p-8 overflow-y-auto h-[calc(100vh-64px)]" aria-label="Main navigation">
         {navArticles.map(article => (
           <a href={`/${article.slug}`} class="block py-4 text-lg font-semibold text-apple-dark border-b border-gray-50">{article.title}</a>
         ))}
      </nav>
    </div>

    <div class="flex max-w-7xl mx-auto min-h-screen">
      <Sidebar articles={navArticles} pathname={pathname} toc={toc} />
      <main id="main-content" class="flex-1 lg:ml-64 px-6 lg:px-16 py-20 lg:py-16">
        <slot />

        <footer class="py-12 mt-20 bg-apple-light border-t border-gray-200 w-[calc(100%+3rem)] lg:w-[calc(100%+8rem)] -mx-6 lg:-mx-16">
          <div class="max-w-3xl mx-auto px-6 text-center space-y-4">
            <p class="text-xs text-gray-500 font-medium">Compiled based on official App Store Review Guidelines.</p>
            <nav class="flex flex-wrap justify-center gap-4 text-xs" aria-label="Footer navigation">
              <a href="/about" class="text-gray-500 hover:text-apple-blue transition-colors">About</a>
              <span class="text-gray-300">|</span>
              <a href="/privacy" class="text-gray-500 hover:text-apple-blue transition-colors">Privacy Policy</a>
              <span class="text-gray-300">|</span>
              <a href="/terms" class="text-gray-500 hover:text-apple-blue transition-colors">Terms of Service</a>
              <span class="text-gray-300">|</span>
              <a href="mailto:support@iossubmissionguide.com" class="text-gray-500 hover:text-apple-blue transition-colors">Contact</a>
            </nav>
            <p class="text-xs text-gray-500">© 2025 iOS Submission Guide. Not affiliated with Apple Inc.</p>
          </div>
        </footer>
      </main>
    </div>

    <script>
      const menuBtn = document.getElementById('mobile-menu-button');
      const closeBtn = document.getElementById('close-menu-button');
      const menu = document.getElementById('mobile-menu');

      function openMenu() {
        menu?.classList.remove('translate-x-full');
        menuBtn?.setAttribute('aria-expanded', 'true');
        document.body.style.overflow = 'hidden';
      }

      function closeMenu() {
        menu?.classList.add('translate-x-full');
        menuBtn?.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
      }

      menuBtn?.addEventListener('click', openMenu);
      closeBtn?.addEventListener('click', closeMenu);

      // Close menu on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !menu?.classList.contains('translate-x-full')) {
          closeMenu();
          menuBtn?.focus();
        }
      });

      // Close menu when clicking nav links
      menu?.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', closeMenu);
      });

      // Shared API base URL helper
      function getApiBase() {
        return window.location.hostname === 'localhost'
          ? 'http://localhost:3005'
          : window.location.origin;
      }

      // Stripe Purchase Handler
      window.handlePurchase = async function() {
        const btn = document.getElementById('paywall-btn') as HTMLButtonElement | null;
        if (!btn) return;

        const originalText = btn.innerText;
        btn.innerText = 'Loading...';
        btn.disabled = true;

        try {
          const response = await fetch(getApiBase() + '/api/create-checkout-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          });
          const data = await response.json();
          if (data.url) {
            window.location.href = data.url;
          } else {
            alert('Error creating checkout session. Please try again.');
            btn.innerText = originalText;
            btn.disabled = false;
          }
        } catch (e) {
          console.error(e);
          alert('Error connecting to server.');
          btn.innerText = originalText;
          btn.disabled = false;
        }
      };
    </script>
  </body>
</html>
